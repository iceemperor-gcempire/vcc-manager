# 작업 일지 - 2026-02-04

## 요청 사항

### LoRA 메타데이터 조회 기능 구현
ComfyUI 서버의 LoRA 목록을 조회하고, Civitai API를 통해 메타데이터(이름, 설명, 미리보기 이미지, 트리거 워드)를 가져와 표시하는 기능 구현 요청

**사용자 요구사항:**
- 해시 방식: ComfyUI 커스텀 노드 활용 (자체 구현)
- 관리 범위: 서버 단위 관리 (여러 작업판이 같은 서버 공유 시 캐시 재사용)
- 기능 범위: 메타 정보 조회만 (즐겨찾기, 다운로드 기능 제외)

---

## 완료된 작업

### 1. LoRA 메타데이터 조회 기능 (커밋: 1975dc0)

**백엔드:**
- `src/models/ServerLoraCache.js` - 서버 단위 LoRA 캐시 모델
- `src/services/loraMetadataService.js` - Civitai API 연동 서비스
- `src/routes/servers.js` - LoRA API 엔드포인트 추가
  - `GET /servers/:id/loras` - LoRA 목록 조회
  - `POST /servers/:id/loras/sync` - 동기화 시작
  - `GET /servers/:id/loras/status` - 동기화 상태 조회

**프론트엔드:**
- `frontend/src/services/api.js` - serverAPI에 LoRA 메서드 추가
- `frontend/src/components/LoraListModal.js` - 카드형 UI로 개선

**ComfyUI 커스텀 노드:**
- `tools/comfyui-vcc-lora-hash/` - SHA256 해시 제공 노드

**문서:**
- `docs/LORA_METADATA.md` - 전체 가이드
- `tools/README.md` - 사전 설치 도구 인덱스

---

### 2. 서버 관리 페이지 동기화 버튼 (커밋: 14ddbc0)

**변경 내용:**
- `frontend/src/components/admin/ServerManagement.js`에 LoRA 동기화 버튼 추가
- ComfyUI 서버에만 동기화 아이콘 표시
- LoRA 수, 메타데이터 상태, 마지막 동기화 시간 표시
- 동기화 중 프로그레스 표시

---

### 3. LoRA 관리 페이지 및 해시 최적화 (커밋: 5c6cff1)

**사용자 요청:**
> "관리자 메뉴에 LoRA관리 메뉴를 추가해 주시고, 현재 서버 목록들 중 하나를 콤보박스에서 선택 시 그 서버가 보유중인 LORA정보가 나오도록 화면을 구성해 주세요."

> "comfyui 노드가 모든 lora 의 해시를 반환하는 것이 아니라, 요청은 오직 하나의 파일만 가능하도록 해야 합니다. lora 리스트는 comfyui 에서 제공하므로, 우선 comfyui 에서 lora 리스트를 받아오고, node로부터 해시값을 받았다면 이 역시 캐시에 같이 보관해야 합니다."

**Admin UI:**
- `frontend/src/pages/admin/LoraManagementPage.js` - LoRA 관리 페이지 신규 생성
- `frontend/src/components/Sidebar.js` - 관리자 메뉴에 "LoRA 관리" 추가
- `frontend/src/App.js` - `/admin/loras` 라우트 추가

**해시 조회 최적화:**
- ComfyUI 커스텀 노드: 전체 목록 → 단일 파일 해시 API로 변경
  - `GET /api/vcc/lora-hash/ping` - 노드 설치 확인
  - `GET /api/vcc/lora-hash/{filename}` - 단일 파일 해시 조회
- 백엔드 동기화 로직 변경:
  1. ComfyUI 기본 API (`/object_info/LoraLoader`)에서 LoRA 목록 조회
  2. 개별 파일별로 해시 요청 (타임아웃 방지)
  3. 해시 캐시 저장 (재동기화 시 재사용)

---

## 발생한 이슈 및 해결

### 이슈 1: 해시 조회 타임아웃
- **원인**: 모든 LoRA 파일의 해시를 한 번에 계산하면 시간이 오래 걸려 타임아웃 발생
- **해결**: 단일 파일 해시 API로 변경, 개별 요청으로 분리

### 이슈 2: Mongoose enum 검증 오류
- **원인**: `progress.stage`에 새로운 값(`checking_node`, `fetching_metadata`)이 enum에 없음
- **해결**: `ServerLoraCache.js` 모델의 enum에 새 값 추가

---

## 관련 커밋

| 커밋 | 설명 |
|------|------|
| 1975dc0 | feat: add LoRA metadata lookup with Civitai integration |
| 14ddbc0 | feat: add LoRA sync button to server management page |
| 5c6cff1 | feat: add LoRA management page and optimize hash fetching |

---

### 4. NSFW 필터링 및 Civitai API 키 기능

**사용자 요청:**
> "1. NSFW 필터링 기능이 필요합니다. 해당 기능의 on / off 정보는 관리자 정보에 기록되어야 합니다. 보이기 기능에만 적용되는 것이므로 서버 단위로 기록할 필요 없이, 관리 기능 레벨에서만 전역 기록되면 됩니다."
>
> "2. LoRA 관리 기능에 Civitai api key 등록 기능이 필요합니다. 또한 civitai api key 를 등록했다면, api 를 통하여 메타 데이터 정보를 가져오는 주기가 지금보다 빨라져야 할 필요가 있습니다."

**백엔드:**
- `src/models/SystemSettings.js` - 전역 시스템 설정 모델 신규 생성
  - `nsfwFilter`: NSFW 필터 설정 (기본값: true)
  - `civitaiApiKey`: Civitai API 키 저장
  - 정적 메서드: `getGlobal()`, `updateLoraSettings()`, `getCivitaiApiKey()`, `getNsfwFilter()`
- `src/services/loraMetadataService.js` - Rate limiting 개선
  - API 키 없음: 1초 간격
  - API 키 있음: 0.2초 간격 (5배 빠름)
- `src/routes/admin.js` - 설정 API 추가
  - `GET /admin/settings/lora` - LoRA 설정 조회
  - `PUT /admin/settings/lora` - LoRA 설정 업데이트

**프론트엔드:**
- `frontend/src/services/api.js` - adminAPI에 설정 메서드 추가
- `frontend/src/pages/admin/LoraManagementPage.js` - 전역 설정 패널 추가
  - NSFW 필터 토글 스위치
  - Civitai API 키 등록/변경/삭제 기능
  - NSFW 이미지 자동 필터링

---

### 5. LoRA 관리 UI 개선

**사용자 요청:**
> "1. NSFW 이미지 필터 기능 외에, NSFW LORA 자체의 필터 기능이 필요합니다."
>
> "2. LoRA목록 그리드 크기가 제멋대로 늘었거나 줄었거나 하고 있는데요. 최소사이즈와 최대사이즈를 지정하여 그 크기 이상만큼 늘어나지 않았으면 합니다."
>
> "3. LoRA 목록 표시 방식을 그리드 방식과 리스트 방식 2가지 중 하나를 고를 수 있으면 좋겠습니다."

**백엔드:**
- `src/models/SystemSettings.js` - `nsfwLoraFilter` 필드 추가
- `src/routes/admin.js` - 설정 API에 nsfwLoraFilter 지원 추가

**프론트엔드:**
- NSFW LoRA 필터링 기능 추가 (Civitai에서 NSFW로 분류된 LoRA 숨기기)
- 그리드 카드 크기 고정 (최소 200px, 최대 280px)
- 뷰 모드 토글 추가 (그리드/리스트)
- `LoraListItem` 컴포넌트 신규 추가 (리스트 뷰용)

---

## 다음 작업 (예정)

- 필요 시 추가 기능 구현
