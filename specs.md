# Visual Content Creator 명세서

> **⚠️ 주의 (Note):**
> 이 문서는 프로젝트 초기 요구사항 명세서이며, 현재 구현된 실제 기능과 다를 수 있습니다.
> 최신 정보는 [README.md](./README.md) 및 [API 문서](./docs/API.md)를 참조하세요.



## 개요

### 서비스 컨셉

* 이 서비스는 comfyUI 등, 이미지 생성 서비스와 연동하여 사용자에게 이미지 생성 ai 서비스를 제공하는 것을 목표로 함.
* 단순히 프롬프트를 주어 이미지를 생성하는 것 뿐만 아니라, 스케치 등의 채색, 이미지 재구성 및 조합 등 다양한 서비스를 제공하며, 이미지 생성 시점에도 다양한 옵션을 제공하는 것을 기본으로 함.

## 구조

### 설정 관리

* 설정 파일은 .env 를 통하여 처리

### 내부 시스템 구성

#### Backend
* API 형태로 서비스 구성
#### Frontend
* Backend API 호출하여 UI 구성

#### 데이터베이스
 * 유저 정보 관리
 * 유저가 생성한 이미지 관리
 * 유저 작업 내역 관리

#### 파일서버
* 유저가 업로드한 이미지 파일 저장
* 유저가 생성한 이미지 파일 저장

### 배포 구성

* docker 사용
* docker 외부로 포트가 노출되는 것은 백엔드와 프론트엔드만.

## 회원 관리 시스템

### 개요

* 로그인은 다음 2가지를 지원한다.
	* 이메일 + 비밀번호
	* 구글 OAuth

### 가입

* 가입 버튼을 누르면 이메일 + 비밀번호 가입 절차를 진행.
* 구글 로그인 시 해당 유저 정보가 없다면 가입 절차로 진행.
* 가입 절차 단계에서 회원 정보 구성에 필요한 정보를 받는다. 해당 정보에 대해서는 “회원정보” 항목 참고

### 회원정보

* 필수 정보는 아래와 같다.
	* 이메일
	* 닉네임
		* 상대방에게 보일 간단한 이름
* 추가적인 정보는 나중에 따로 추가 예정. 현재는 개인정보 관리 최소화를 위해 추가로 받지 않음.

## 관리자 설정

* 관리자라고 별도의 가입 절차는 진행하지 않는다. 관리자나 일반 유저나 동일하게 회원 관리 시스템에 언급된 대로 가입함.
* 관리자의 지정은 .env 파일에서 지정한 관리자 계정 이메일과 동일한 회원 계정이 관리자 권한을 가진다.
* .env 에서 관리자 계정 이메일을 바꾸면 바로 관리자 계정이 변경되는 구조

## 유저 기능 목록

### 작업판 선택

* 유저는 이미지를 생성하기 전 작업판을 선택해야 함.
* 작업판에는 이미지 생성에 어떤 모델을 선택할 지, 어떤 파라메터를 사용할 지에 대한 정보가 담겨 있다.

### 이미지 생성 기능

* 작업판을 선택하면, 작업판 수행에 필요한 입력 데이터 폼이 나타나며, 이들 입력 폼을 모두 작성하면 이미지를 생성할 수 있다.
* 이미지 생성 기능을 시작하면, 이미지 생성 작업 목록에 추가되며, 이후에는 유저가 접속을 끊거나 브라우저를 닫는다고 하더라도 알아서 작업을 내부적으로 진행한다. 즉 백엔드에서 자체적으로 진행되며, 유저가 다시 접속하면 상태를 확인할 수 있다. 이는 작업시간이 너무 오래 걸려 타임아웃 날 때를 대비하기 위한 것이다.
* 가능하다면 이미지 생성 과정을 보여줄 수 있다.
* 이미지 생성이 완료되면 생성 이미지로 저장된다.

### 이미지 업로드 및 관리 기능

* Image to Image 및 Controlnet Canny, Scribble 등에 사용할 이미지들을 업로드하고 관리하는 기능
* 업로드 한 이미지들을 목록으로 볼 수 있으며 추가 및 삭제가 가능하다.
* 기존 이미지 생성 작업에 사용된 이미지라면, 해당 이미지 생성 작업이 기록에 남아 있는 동안에는 참조되어 있다고 표시된다.
	* 차후 참조된 작업으로 이동하는 기능도 제공할 예정.
* 이미지 생성 > 참고 이미지 에서 이미지 업로드 시 이미지 업로드 목록에 등록된다.
* 이미지 생성 > 참고 이미지 에서 생성 이미지 지정 시에는 이 목록에 등록되지 않는다.
* 이미지 선택 시 이미지가 확대 디스플레이 되며, 이미지 메타 정보도 같이 확인할 수 있다.

### 이미지 생성 작업 관리 기능

* 이미지 생성 작업을 진행한 이력을 다시 볼 수 있다.
* 이미지 생성에 사용한 모든 입력값을 확인 가능하다. 참조한 이미지 포함.
* 이력은 삭제 가능하다. 다만 이력을 삭제한다고 생성한 이미지가 삭제되지는 않음에 유의
* 이미지 선택 시 이미지가 확대 디스플레이 되며, AI 이미지 생성에 사용된 프롬프트와 각종 옵션값들을 확인할 수 있다.

### 생성 이미지 관리 기능

* 생성 이미지의 조회 및 추가 삭제 가능
* 생성한 이미지를 삭제할 경우, 해당 이미지를 생성한 이력이 같이 삭제된다.
	* 삭제 시도 시 이력도 삭제할 것이라고 묻는다.

## 관리자 기능 목록

### 작업판 관리 기능

* 작업판에 대한 CRUD 작업
* 작업판 내부의 추가 작업 입력값 항목을 추가 및 삭제 가능
	* 작업 기초 입력값 항목 추가 및 삭제는 불가능하다.
        * 선택 타입의 경우 어떤 값을 선택할 수 있는지에 대한 항목도 추가제거 가능함.
* 작업판의 작업 흐름 데이터 수정 기능.
	* 작업 흐름 데이터는 아래 “작업 흐름 데이터” 참고

### 회원 관리 기능

* 회원 삭제 기능


## 데이터 타입

## 작업판

* 이미지 생성 작업을 하기 위해 필요한 입력 형식 및, 실제 접속해야 할 이미지 생성 서비스 주소들을 저장한 정보.
* 아래와 같은 데이터를 가진다

### 작업판 정보

* 작업판 이름
	* 구분할 용도
* 접속 서버 주소
	* 현재는 ComfyUI 서버만 제공함.
* 작업 입력값 설정
	* 작업 
* 작업 흐름 데이터
	* 현재는 ComfyUI Workflow 데이터를 사용함.
	* 작업 흐름 데이터에 대해서는 작업 흐름 데이터 항목에서 따로 설명

### 작업 입력값

* 작업 입력값은 이미지 생성을 위해 서버에 접속 후 작업 흐름 실행 시 필요한 값들을 말한다.
* 아래와 같은 값들을 가진다.

#### 작업 기초 입력값

* 다음의 항목을 선택 및 입력 가능하다.
	* AI 이미지 모델 데이터 경로
		* 타입 : 선택항목
		* 예) 
			* WAI Illustrious
			* ZIT fp8 distilled
			* Qwen2512
	* 프롬프트
		* 타입 : 문자열
		* 이미지 생성에 사용할 프롬프트
	* 참고 이미지
		* 타입 : 파일 목록
		* 이미지 생성에 참고로 사용될 이미지
		* 여러 장 추가 가능.

#### 작업 추가 입력값

* 관리자의 설정에 따라 아래와 같은 추가 입력값이 들어갈 수 있다.
	* 이미지 생성 크기
		* 타입 : 문자열
		* 각 모델에 맞는 최적의 이미지 목록 리스트로부터 이미지 크기를 고를 수 있다.
	* 참고 이미지 사용방식
		* 타입 : 선택항목
		* Image to Image : 참고 이미지를 현재 모델 스타일 이미지로 재생성
		* Controlnet : 참고 이미지를 Controlnet 용도로 사용
			* Controlnet Canny : 참고 이미지를 스케치로 사용
			* Controlnet Scribble : 참고 이미지를 기초적인 레이아웃 용도로 사용.
		* 기타
	* 부정 프롬프트
		* 타입 : 문자열
		* 부정 프롬프트를 직접 입력할 수 있다. 다만 모델별로 부정 프롬프트가 의미없는 경우가 있음에 유의.
	* 업스케일 방법 설정
		* 타입 : 문자열
	* 기초 Style 설정
		* 타입 : 선택항목
		* 그림체 등과 같이 기본적으로 사용할 LoRA를 설정할 용도. 일종의 편의 기능이다.

### 타입 : 선택항목

* key : value 의 집합으로 되어 있다.
* UI 로 표현 시에는 콤보박스 형태로 표시되며, 콤보박스 내 목록은 해당 집합이 key 에 대한 문자열 오름차순 정렬로 표시되어야 한다.
* 목록 내에서는 key값으로 표시되며, 실제 적용시에는 value값이 사용된다.


### 작업 흐름 데이터

* ComfyUI Workflow 데이터를 기반으로 하는 json문자열값이다. 다만 작업판의 작업 입력값을 주입하기 위한 형식으로 변경되어 있다.
* 관리자는 ComfyUI Workflow 의 API 용 export 데이터를 텍스트 데이터로 직접 입력하며, 작업판의 작업 입력값을 해당 문자열 내부에 Dify 등에서 사용하는 Mustache 형식의 주입형을 사용한다
	* 예) {{##prompt##}}

## 이미지 생성 서버 접속 후 처리 과정

1. ComfyUI 서버 접속
2. 작업 흐름 데이터에 작업 입력값을 주입하여 ComfyUI Workflow 추가
3. 저장된 작업 흐름 데이터를 workflow 로 전달.
4. 비동기 처리를 위해 작업 id 를 따로 할당받음.
5. 결과 도착 notify 또는 polling 으로 작업 완료 확인되면
	1. 이미지 생성 작업 업데이트
	2. 수신한 이미지를 이미지 생성 목록에 저장
